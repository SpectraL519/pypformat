name: tests
on:
  push:
    branches:
      - '*'
    paths:
      - .github/workflows/tests.yaml
      - src/**
      - test/**
      - pyproject.toml

jobs:
  run_tests_with_coverage:
    name: Run tests with coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: |
            3.9
            3.10
            3.11
            3.12
            3.13
          cache: 'pip'

      - name: Install dependencies
        run: python -m pip install tox

      - name: Run tox
        run: tox

      - name: Debug coverage files
        if: failure() || always()
        run: |
          cat .coverage.json || echo "The `.coverage.json` was not found!"
          echo "> Root dir:"
          ls -al

      # - name: Upload the JSON coverage report
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: coverage-json
      #     path: .coverage.json
      #     include-hidden-files: true

      - name: Prepare the covbadge data
        run: |
          export TOTAL_COV=$(python -c "import json; print(json.load(open('.coverage.json'))['totals']['percent_covered_display'])")
          echo total_cov=$TOTAL_COV >> $GITHUB_ENV
          echo ### Total coverage: ${TOTAL_COV}% >> $GITHUB_STEP_SUMMARY

      # Generate the the coverage badge
      - name: Generate the covbadge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: 60ba7283e412ea91cd2db2b3b649003d
          label: coverage
          filename: pypf_covbadge.json
          message: ${{ env.total_cov }}%
          valColorRange: ${{ env.total_cov }}
          minColorRange: 50
          maxColorRange: 90

      # Optional: Upload the badge as an artifact (if you want to store it for reference)
      # - name: Upload coverage badge artifact
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     message: ${{ env.total_cov }}%
      #     name: coverage-badge
      #     path: coverage-badge.svg
